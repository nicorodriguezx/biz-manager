{% extends "base.html" %}
{% block content %}
<h2>
    <i class="fas fa-users"></i>
    Usuarios
</h2>

<div class="card">
    <div class="card-body">
        <!-- Add User Button - Visible on mobile -->
        <button type="button" 
                class="btn-text btn-primary add-user-toggle" 
                onclick="toggleNewUserForm()">
            <i class="fas fa-plus"></i>
            Agregar Usuario
        </button>

        <!-- Add User Form -->
        <form id="new-user-form" class="user-form" style="display: none;">
            <div class="form-header">
                <h3>Nuevo Usuario</h3>
                <button type="button" class="btn-text btn-cancel" onclick="toggleNewUserForm()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Usuario</label>
                    <input type="text" class="form-input username-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Rol</label>
                    <select class="form-input role-input" onchange="handleNewRoleChange()">
                        <option value="user">Usuario</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="form-group commission-group">
                    <label class="form-label">Comisión</label>
                    <input type="number" 
                           class="form-input commission-input"
                           step="0.1" 
                           min="0" 
                           max="100"
                           placeholder="Comisión %">
                </div>
                <div class="form-group">
                    <label class="form-label">Contraseña</label>
                    <input type="password" 
                           class="form-input password-input" 
                           required>
                </div>
            </div>
            <div class="button-group">
                <button type="button" onclick="saveNewUser()" class="btn-text btn-save">
                    <i class="fas fa-save"></i>
                    Guardar
                </button>
            </div>
        </form>

        <!-- Users List -->
        <div class="users-list">
            {% for user in users if user.exists != 'false' %}
            <div class="user-card" data-id="{{ user.user_id }}">
                <div class="user-info">
                    <div class="user-main">
                        <h3>{{ user.username }}</h3>
                        <span class="user-role">{{ user.role }}</span>
                    </div>
                    {% if user.role == 'user' %}
                    <div class="user-commission">
                        <span class="commission-value">{{ "%.2f"|format(user.commission_rate * 100) }}%</span>
                        <span class="commission-label">comisión</span>
                    </div>
                    {% endif %}
                </div>
                <div class="user-actions">
                    <button type="button" onclick="editUser({{ user.user_id }})" class="btn-text btn-edit">
                        <i class="fas fa-edit"></i>
                        <span class="btn-label">Editar</span>
                    </button>
                    {% if user.user_id != current_user.user_id %}
                    <button type="button" onclick="deleteUser({{ user.user_id }})" class="btn-text btn-delete">
                        <i class="fas fa-trash"></i>
                        <span class="btn-label">Eliminar</span>
                    </button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
function toggleNewUserForm() {
    const form = document.getElementById('new-user-form');
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
}

function editUser(userId) {
    const card = document.querySelector(`div[data-id="${userId}"]`);
    const userData = {
        username: card.querySelector('.user-main h3').textContent,
        role: card.querySelector('.user-role').textContent,
        commission_rate: card.querySelector('.commission-value')?.textContent.replace('%', '') / 100 || 0
    };

    card.innerHTML = `
        <div class="form-grid">
            <div class="form-group">
                <label class="form-label">Usuario</label>
                <input type="text" class="form-input username-input" value="${userData.username}" required>
            </div>
            <div class="form-group">
                <label class="form-label">Rol</label>
                <select class="form-input role-input" onchange="handleRoleChange(${userId})">
                    <option value="user" ${userData.role === 'user' ? 'selected' : ''}>Usuario</option>
                    <option value="admin" ${userData.role === 'admin' ? 'selected' : ''}>Admin</option>
                </select>
            </div>
            <div class="form-group commission-group" ${userData.role === 'admin' ? 'style="display:none"' : ''}>
                <label class="form-label">Comisión</label>
                <input type="number" 
                       class="form-input commission-input"
                       step="0.1" 
                       min="0" 
                       max="100"
                       value="${userData.commission_rate * 100}"
                       placeholder="Comisión %">
            </div>
            <div class="form-group">
                <label class="form-label">Contraseña</label>
                <input type="password" 
                       class="form-input password-input" 
                       placeholder="Dejar en blanco para mantener">
            </div>
        </div>
        <div class="user-actions">
            <button onclick="saveChanges(${userId})" class="btn-text btn-save">
                <i class="fas fa-save"></i>
                <span class="btn-label">Guardar</span>
            </button>
            <button onclick="cancelEdit(${userId}, ${JSON.stringify(userData)})" class="btn-text btn-cancel">
                <i class="fas fa-times"></i>
                <span class="btn-label">Cancelar</span>
            </button>
        </div>
    `;
}

function handleRoleChange(userId) {
    const card = document.querySelector(`div[data-id="${userId}"]`);
    const roleSelect = card.querySelector('.role-input');
    const commissionGroup = card.querySelector('.commission-group');
    
    commissionGroup.style.display = roleSelect.value === 'user' ? 'block' : 'none';
}

function saveChanges(userId) {
    const card = document.querySelector(`div[data-id="${userId}"]`);
    const data = {
        username: card.querySelector('.username-input').value,
        role: card.querySelector('.role-input').value,
    };

    if (data.role === 'user') {
        data.commission_rate = parseFloat(card.querySelector('.commission-input').value) / 100;
    }

    const password = card.querySelector('.password-input').value;
    if (password) {
        data.password = password;
    }

    fetch(`/admin/users/${userId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert(data.error || 'Error al actualizar el usuario');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al procesar la solicitud');
    });
}

function cancelEdit(userId, userData) {
    const card = document.querySelector(`div[data-id="${userId}"]`);
    card.innerHTML = `
        <div class="user-info">
            <div class="user-main">
                <h3>${userData.username}</h3>
                <span class="user-role">${userData.role}</span>
            </div>
            ${userData.role === 'user' ? `
            <div class="user-commission">
                <span class="commission-value">${(userData.commission_rate * 100).toFixed(2)}%</span>
                <span class="commission-label">comisión</span>
            </div>
            ` : ''}
        </div>
        <div class="user-actions">
            <button onclick="editUser(${userId})" class="btn-text btn-edit">
                <i class="fas fa-edit"></i>
                <span class="btn-label">Editar</span>
            </button>
            ${userId !== {{ current_user.user_id }} ? `
            <button onclick="deleteUser(${userId})" class="btn-text btn-delete">
                <i class="fas fa-trash"></i>
                <span class="btn-label">Eliminar</span>
            </button>
            ` : ''}
        </div>
    `;
}

function deleteUser(userId) {
    if (!confirm('¿Está seguro de que desea eliminar este usuario?')) {
        return;
    }

    fetch(`/admin/users/${userId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert(data.error || 'Error al eliminar el usuario');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al eliminar el usuario');
    });
}

function handleNewRoleChange() {
    const roleSelect = document.querySelector('#new-user-row .role-input');
    const commissionInput = document.querySelector('#new-user-row .commission-input');
    
    if (roleSelect.value === 'user') {
        commissionInput.style.display = 'block';
    } else {
        commissionInput.style.display = 'none';
        commissionInput.value = '';
    }
}

function saveNewUser() {
    const row = document.getElementById('new-user-row');
    const data = {
        username: row.querySelector('.username-input').value,
        password: row.querySelector('.password-input').value,
        role: row.querySelector('.role-input').value,
    };

    if (!data.username || !data.password) {
        alert('Por favor complete los campos requeridos');
        return;
    }

    if (data.role === 'user') {
        const commission = row.querySelector('.commission-input').value;
        if (!commission) {
            alert('Por favor ingrese un valor de comisión');
            return;
        }
        data.commission_rate = parseFloat(commission) / 100;
    }

    fetch('/admin/users', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert(data.error || 'Error al crear el usuario');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al crear el usuario');
    });
}
</script>
{% endblock %}